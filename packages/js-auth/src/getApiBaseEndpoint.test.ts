import { InvalidTokenError } from './errors/InvalidTokenError.js'
import { TokenError } from './errors/TokenError.js'
import { getApiBaseEndpoint } from './getApiBaseEndpoint.js'

describe('getApiBaseEndpoint', () => {
  it('should throw when the access token is not valid.', () => {
    const accessToken =
      'eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsImtpZCI6ImFiYTRjYzYyOGQxZmNlM2ZiOTNhM2VlNTU4MjZlNDFjZmFmMThkYzJkZmYzYjA3MjIyNzQwMzgwZTkxOTlkNWQifQ.eyJ1c2VyIjp7ImlkIjoiZ2Jsb3dTeVZlcSJ9LCJhcHBsaWNhdGlvbiI6eyJpZCI6Im5HVnFhaWxWeU4iLCJraW5kIjoiZGFzaGJvYXJkIiwicHVibGljIjpmYWxzZX0sInNjb3BlIjoibWV0cmljcy1hcGkiLCJleHAiOjE3MTA5NzY2OTUsInRlc3QiOmZhbHNlLCJyYW5kIjowLjc2NTI4MDA3NjA2NTIzMDcsImlhdCI6MTcxMDk2OTQ5NSwiaXNzIjoiaHR0cHM6Ly9jb21tZXJjZWxheWVyLmlvIn0.MndfYcXvsCWoEePd-D8VPNzXLFg-uutEa9x-sEQgKzxi5ZRACDr-LhaSeuersSDq3cJu_jRaNHt93Yt50Q6VsUNvnrkmMfm1K-fe3TyOGM1wyNSkNp-Eu716l6v6jHjZmLxgC5On50fk_HDhFk9gcTIkLeUy1PQ8aBZsrkK9IqISlv0f0DDVgpSv7bljdoETyLKtF1oChiNnqRAN8Ywe8O0qvA5m4Gh6FYJKC6gYLIoIl57-JYzKxZ3zR3QoZPXFMv9OFVgdplQSiuRq8QANs_Ne1wQ6ZUeplHY9RAUCpfvHc7TfwzwI6P1i-1Pd4iI7yl9e9vyTRtYW7WONGVfNufNi9NHyDq-eBlo6jwMK3cTLxMWQOVPG75NEPdUF4X_R2PBUJ1bpalVFBtwNr2AKl5gtXK1sJz7ofi4eynTwe6UZxUOR4xSW-R8-zA6CeIO_5VPC68wdtBVhRydaj4HK2ngFZ8T3SUEk3ecc91C3cRLK2hGzz5kEZcMdlaFw5N2ckvvM5EtZEchc1ZJbCG9SsfYBkDpzWa0d7EV1WHmbrYIRWuf1wQ1uR6bCYJCwrYwDx_R3m3mljON3MKtp6DOfl-Rrn9WoSK1k5xIRX3uD6WvDVRR2HoUqFWR82sd2N5tT3t3iYiCxrOB36WGaPrifvGk70ddRW7mjMr0KDhbM014'

    expect(() => getApiBaseEndpoint(accessToken)).toThrow(InvalidTokenError)
    expect(() => getApiBaseEndpoint(accessToken)).toThrow(TokenError)
    expect(() => getApiBaseEndpoint(accessToken)).toThrow(
      'Invalid token format'
    )
  })

  it('should return the core api endpoint when access token contains an "organization".', () => {
    expect(
      getApiBaseEndpoint(
        'eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsImtpZCI6ImFiYTRjYzYyOGQxZmNlM2ZiOTNhM2VlNTU4MjZlNDFjZmFmMThkYzJkZmYzYjA3MjIyNzQwMzgwZTkxOTlkNWQifQ.eyJvcmdhbml6YXRpb24iOnsiaWQiOiJlbldveEZNT25wIiwic2x1ZyI6InRoZS1ibHVlLWJyYW5kLTMiLCJlbnRlcnByaXNlIjpmYWxzZSwicmVnaW9uIjoiZXUtd2VzdC0xIn0sImFwcGxpY2F0aW9uIjp7ImlkIjoibkdWcWFpRVlOQSIsImNsaWVudF9pZCI6IjF1bEs3ZXdkUUZyak90LVlxZ0RQeXBRRzFYSmVtUGdaUDFvd3NpSG9tRDQiLCJraW5kIjoic2FsZXNfY2hhbm5lbCIsInB1YmxpYyI6dHJ1ZX0sInNjb3BlIjoibWFya2V0OmFsbCIsImV4cCI6MTcyNTM5OTc3OCwidGVzdCI6dHJ1ZSwicmFuZCI6MC4yMTIzMDUzMTE1NDg3Njk5NywiaWF0IjoxNzI1MzkyNTc4LCJpc3MiOiJodHRwczovL2F1dGguY29tbWVyY2VsYXllci5jbyJ9.aOjfJXPDQ-jY__XlZuaAhpboDCGPuaszSMjgBlGJ7ubjWmmHGIvgOewNusTKRcrvhgWsUPeGeBii9SdkxP0tHMejXb0qS8RZ7lAxhvfHlekytdhizLrTUoqAwGckgX9FJTzRh0rA57cFXLSuXXUvB5aUtFZ3CfxZ_YIRWUNSvbAsknYmH1WAy54QjpvM9jFD3iXv3ak9Q9DnxC80N98lgWfgjEgoW67jQSLHQT0r-cgbT8dbVUDOkUp4PnUQkjLWHcoejRFMlORTlQTSGjW8pYsYJyKhUa8FJ9UWcRGp55xIJLmdqbVcdYo0R2ESz32ek-Uu3OTO-JAbABSC-oN5Dzo_BHxS7ct_TcZV9Qxr-fGdZXD0C5PljMqmAQMeSRoZjdSLSLLKq5dyUx714NT9urE_BVLTkZ-jU-15iyS3aWy0qgmMKu3NOBmF_j-P7ohNNjDsdMz2ofZ8r2E_0QBgpC1LwdWt4r0S4eabiTskM4r-wrQSbctZae0veIrKQ4C3k1Wr1wR9b6CvZXr-IqaYg1VilMiffmVhbYl60iWg3IK5REKJFJ2hNm18A78OiBO4A5KiL6lk3N_26C9dJa9HolUbpopiIVgZxXUXRw6EohnU0e5IBnQES-3q9T_37lNgAKlbHpqDKKEWjdwqb3GRMdxzMj0rxELyBRBbx-W8_9s'
      )
    ).toEqual('https://the-blue-brand-3.commercelayer.co')

    expect(
      getApiBaseEndpoint(
        'eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsImtpZCI6ImFiYTRjYzYyOGQxZmNlM2ZiOTNhM2VlNTU4MjZlNDFjZmFmMThkYzJkZmYzYjA3MjIyNzQwMzgwZTkxOTlkNWQifQ.eyJvcmdhbml6YXRpb24iOnsiaWQiOiJlbldveEZNT25wIiwic2x1ZyI6InRoZS1ibHVlLWJyYW5kLTMiLCJlbnRlcnByaXNlIjpmYWxzZSwicmVnaW9uIjoiZXUtd2VzdC0xIn0sImFwcGxpY2F0aW9uIjp7ImlkIjoibkdWcWFpRVlOQSIsImNsaWVudF9pZCI6IjF1bEs3ZXdkUUZyak90LVlxZ0RQeXBRRzFYSmVtUGdaUDFvd3NpSG9tRDQiLCJraW5kIjoic2FsZXNfY2hhbm5lbCIsInB1YmxpYyI6dHJ1ZX0sInNjb3BlIjoibWFya2V0OmFsbCIsImV4cCI6MTcyNTM5OTc3OCwidGVzdCI6dHJ1ZSwicmFuZCI6MC4yMTIzMDUzMTE1NDg3Njk5NywiaWF0IjoxNzI1MzkyNTc4LCJpc3MiOiJodHRwczovL2F1dGguc3RnMS5jb21tZXJjZWxheWVyLmNvIn0.oQRimLI0JHMnNtm_j-VwtqIjR-IafvukM8XB5RlxOmhfKvEAyCRbVDKQqk09n9p5cVBiOFbbiXxg8hSHXVqx-FfD14tDO7OgYzB9V7uWVrkOrof2kUTdy15IubpSDGk_X9qlwq1Rv5CgofCPRCvTlEI4Es2LcS6WLj-Q2pjqe6aP3tP6_Ne_bHz0oue5vXgs_noNLYPsYs4IIcwvPMU6R0EXnBJ5BdEplBiGhRyoQ_LUtUNKFQnoLeGk5_rKK6soP72w-Xi-tlR7rNw--fDbrTYH5XrkoD-QGiyMUk2Y-Vi6xpKNQ1wHky7WnuhOtJAy_-C90Zq6wfncQ5pBXT4rQ1HyNzzNgj9EpkkZTgNqy5fp8e62JKxpQRTz8es_4uVGLq_rn8CZZ7HX-C9-87AgebckDIWO9SCTtn8EOTMsu-wqzf3EQjFE35e78sNrVMqHMToW7QnCnellq4tdHp3oIiOHgIDjEQCQQytipH8cYIHqGxG-oUUatG77elFOvNH-9K38l1W0pfdgyfl27cnYbEDFWAf3yicrfiVlX77_PkTuE2dC910rNQ3Eg4XY7BxWMgoVSeBD2Bf1OjvyFCoxZEBfuC_7U7i5VR88pPGSF2dU9DGVwe-KhPasjv_p2O0lboL48ic7Icdvhy7c-MvGUTV5O8bxNjN0MJ39MYrwaUQ'
      )
    ).toEqual('https://the-blue-brand-3.stg1.commercelayer.co')
  })

  it('should fallback to "commercelayer.io" when "iss" is expressed in an old format.', () => {
    const accessToken =
      'eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsImtpZCI6ImFiYTRjYzYyOGQxZmNlM2ZiOTNhM2VlNTU4MjZlNDFjZmFmMThkYzJkZmYzYjA3MjIyNzQwMzgwZTkxOTlkNWQifQ.eyJvcmdhbml6YXRpb24iOnsiaWQiOiJlbldveEZNT25wIiwic2x1ZyI6InRoZS1ibHVlLWJyYW5kLTMiLCJlbnRlcnByaXNlIjpmYWxzZSwicmVnaW9uIjoiZXUtd2VzdC0xIn0sImFwcGxpY2F0aW9uIjp7ImlkIjoibkdWcWFpRVlOQSIsImtpbmQiOiJzYWxlc19jaGFubmVsIiwicHVibGljIjp0cnVlfSwic2NvcGUiOiJtYXJrZXQ6YWxsIiwiZXhwIjoxNzEwOTU3NjMwLCJ0ZXN0Ijp0cnVlLCJyYW5kIjowLjM0Nzg4MjA0NDE1NDI0Njk1LCJpYXQiOjE3MTA5NDMyMzAsImlzcyI6Imh0dHBzOi8vY29tbWVyY2VsYXllci5pbyJ9.XhcMqwVwAh5wP2rbNyODBuPpTicwJjvK09KPmhe3nM1Lg0Hp0bIEQIOS81ohLyLE9ecaRH_7CsfLkAqYmRtdOTAKu9m4xvWw-Z_hBQpY67FTaikInMVltNffLvNDe5qmleNi5jnXtJl_yEGhtlDydpFBx1x8u3ofgtZSPFWm3Tl4KQoxFxT8CnnxPd2LTW_PfvnqS3QEGgvVnEXSTnJ41EU4dB8c9cZmmJY6e9SeH9fHVd469N_ipP4bymIL7kLPpkBBDuxxZ0787dOblGI31geAW-hHGbCpnj4_i5WJAVVsj_ImBtqt9Bihc-O-iHIMJlVOzWWXTAnmWGsHiwL5Ag'

    expect(getApiBaseEndpoint(accessToken)).toEqual(
      'https://the-blue-brand-3.commercelayer.io'
    )
  })

  it('should return the provisioning api endpoint when access token contains "provisioning-api" scope.', () => {
    const accessToken =
      'eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsImtpZCI6ImFiYTRjYzYyOGQxZmNlM2ZiOTNhM2VlNTU4MjZlNDFjZmFmMThkYzJkZmYzYjA3MjIyNzQwMzgwZTkxOTlkNWQifQ.eyJ1c2VyIjp7ImlkIjoiZ2Jsb3dTeVZlcSJ9LCJhcHBsaWNhdGlvbiI6eyJpZCI6Im5HVnFhaWxWeU4iLCJraW5kIjoidXNlciIsInB1YmxpYyI6ZmFsc2V9LCJzY29wZSI6InByb3Zpc2lvbmluZy1hcGkiLCJleHAiOjE3MTA5NTA0MzAsInRlc3QiOmZhbHNlLCJyYW5kIjowLjY2OTAzODQ1MzY1NjE5MzMsImlhdCI6MTcxMDk0MzIzMCwiaXNzIjoiaHR0cHM6Ly9jb21tZXJjZWxheWVyLmlvIn0.NB1PVDXU-CbatAkOKUyKDVo4e1YrracajM1JXUZCnDqGPyD2oMzCQC9ztqtOXrbvlV3FHIWm0yzd8yQvKokFjvPDDH9TvfuWgi_hFN-Dh_7IZBj0tUBfUmF694QfrUOoRfX5OX-jBkRk0IrlYUi2WleiilkSbTV9YdAiLNDWFA1MjeK7YS-QLzrrYL6RsUcII4qrDb7UZZOWiZiXTbZ1HFiSZacrZfu3Eu1BGKVUl8ZhhgYOJ1mCPlVmqn4OTnMfZby8M8Jvo3z7HDbC1-lCWMhoQ7o_PH-duA4DnaMyVrchw1S_3aSmVx6rWykvZ80d9Qz-8oSvqZwhkmnMFvUKvQ'

    expect(getApiBaseEndpoint(accessToken)).toEqual(
      'https://provisioning.commercelayer.io'
    )
  })

  it('should return the provisioning api endpoint when access token contains "provisioning-api" scope (stg env).', () => {
    const accessToken =
      'eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsImtpZCI6ImFiYTRjYzYyOGQxZmNlM2ZiOTNhM2VlNTU4MjZlNDFjZmFmMThkYzJkZmYzYjA3MjIyNzQwMzgwZTkxOTlkNWQifQ.eyJ1c2VyIjp7ImlkIjoiZ2Jsb3dTeVZlcSJ9LCJhcHBsaWNhdGlvbiI6eyJpZCI6Im5HVnFhaWxWeU4iLCJraW5kIjoidXNlciIsInB1YmxpYyI6ZmFsc2V9LCJzY29wZSI6InByb3Zpc2lvbmluZy1hcGkiLCJleHAiOjE3MTA5NTA0MzAsInRlc3QiOmZhbHNlLCJyYW5kIjowLjY2OTAzODQ1MzY1NjE5MzMsImlhdCI6MTcxMDk0MzIzMCwiaXNzIjoiaHR0cHM6Ly9hdXRoLmNvbW1lcmNlbGF5ZXIuY28ifQ.EEOTNia5Er_ObuwC91AxXC1y8ORnQPA4d4i4girU_u1VEyzXdVzdgZXFY0rx993TR4m7b7AOD-O3XJHpQPNENBIDkA6nAiAA0yltsslXzgWoJGzk3xnMCS8jrdOjWmgHXOeMtkRjPiZxdPC_jv705bihqmmjDIg-oT9Ez_p7rlssfE2nkc7-YzOcFRKlFlZqIehWuNNykQ9_fTjYV_L5eaApsRYEXvPIiC4UAWOAOA0liIjFBwS1dMAK3xpnhXjBZV1yFeqqiyV7MXdyRhBernd-Htt72Z3_S9It-ke8vmUyFxKmr9H4OFRn7PNVS_cEQvBk5-8pondWrHl5RlNDMGhXWIzsvAKrjYtUEeLogDphjO9x7oaaC770FkiTlbqV54Mt1IslgoV_2J9tjF9aAln4OoenUxBGFVVcrVPwfoJGuQFUdQ8EkUWf7z6ecZFhtBopSN_-zf9dOeukb--SQ-85gZGX_CJ8EcrKcqbBso2OBc6qrTFHNbXHfInyuRK70iVLjZNlbPDKcKE9Z2CFswmoXz1BY75mWewSFYK04R1IcVhhmrJEZdmGWt3-p22lOp5BMj_EjYDrXDRyGT4LiBIG9W3ovLYun3L_Te5_fGlXk2WzEWoX3WtWKZF9EO9aYWsBFiPKNnUiR0c8-5gj3dUTExkix9p4NwZW_9QlK-E'

    expect(getApiBaseEndpoint(accessToken)).toEqual(
      'https://provisioning.commercelayer.co'
    )
  })
})
